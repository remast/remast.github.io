<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Jan Stamer - Coder und Creator von nachhaltigen Lösungen mit Java und Go. Teilt sein Wissen als Speaker und Autor."><script src=https://kit.fontawesome.com/4c09906fcb.js async></script><script src=/turbo-7.3.0.es2017-umd.js async></script><link rel=stylesheet href=https://remast.github.io/css/style.min.10e5cf2701424b4bdfdcaa5c67a67eba0c9884019e4752e9a95e3a860cb39426.css integrity="sha256-EOXPJwFCS0vf3KpcZ6Z+ugyYhAGeR1LpqV46hgyzlCY=" media=screen><link rel=stylesheet href=/flexboxgrid-6.3.1.min.css type=text/css><link rel=canonical href=https://dev.to/remast/go-integration-tests-using-testcontainers-9o5><meta property="og:title" content="Go Integration Tests using Testcontainers"><meta property="og:description" content="How do you test your Go application is working properly with a real PostgreSQL database? Right, you need to test against a real db. You'll learn how easy it is to write integration tests for your Go application using Testcontainers and Docker."><meta property="og:type" content="article"><meta property="og:url" content="https://remast.github.io/posts/2022-08_go-for-testcontainers/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-29T12:11:13+00:00"><meta property="article:modified_time" content="2022-08-29T12:11:13+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Integration Tests using Testcontainers"><meta name=twitter:description content="How do you test your Go application is working properly with a real PostgreSQL database? Right, you need to test against a real db. You'll learn how easy it is to write integration tests for your Go application using Testcontainers and Docker."><meta name=twitter:creator content="jsTamer21k"><title>>_ Jan Stamer | Go Integration Tests using Testcontainers</title></head><body><div id=hero><h1 class=title><a href=/>Jan Stamer</a></h1><div class=social><a href=https://www.linkedin.com/in/jan-stamer><i class="fab fa-linkedin-in"></i></a>
<a href=https://github.com/remast/><i class="fab fa-github"></i></a>
<a href=https://dev.to/remast><i class="fab fa-dev"></i></a></div></div><nav id=nav><a href=/talks/ title>Vorträge</a>
<a href=/articles/ title>Artikel</a>
<a href=/posts/ title>Blog</a></nav><div id=content><h1>Go Integration Tests using Testcontainers</h1><time datetime=2022-08-29>08/2022</time>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"NewsArticle","headline":"Go Integration Tests using Testcontainers","author.name":"Jan Stamer","datePublished":"2022-08-29","dateModified":"2022-08-29"}</script><article><p>Your application uses a database like PostgreSQL? So how do you test your persistence layer to ensure it&rsquo;s working properly with a real <a href=https://www.postgresql.org/>PostgreSQL</a> database? Right, you need to test against a real PostgreSQL. Since that test requires external infrastructure it&rsquo;s an <em>integration test</em>. You&rsquo;ll learn now how easy it is to write integration tests for external infrastructure using <a href=https://golang.testcontainers.org/>Testcontainers</a> and <a href=https://www.docker.com/>Docker</a>.</p><h2 id=integration-test-setup>Integration Test Setup</h2><p>Our application stores users in a <a href=https://www.postgresql.org/>PostgreSQL</a> database. It uses the struct <code>UserRepository</code> with a method <code>FindByUsername</code> that uses plain SQL to find a user by username. We will write an integration test running against a real PostgreSQL in <a href=https://www.docker.com/>Docker</a> for the method <code>FindByUsername</code>.</p><p>The integration test for the <code>FindByUsername</code> of our <code>UserRepository</code> looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestUserRepository</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Setup database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dbContainer</span>, <span style=color:#a6e22e>connPool</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>SetupTestDatabase</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dbContainer</span>.<span style=color:#a6e22e>Terminate</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Create user repository
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>repository</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewUserRepository</span>(<span style=color:#a6e22e>connPool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Run tests against db
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;FindExistingUserByUsername&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>adminUser</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>FindByUsername</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>is</span>.<span style=color:#a6e22e>NoErr</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>is</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>adminUser</span>.<span style=color:#a6e22e>Username</span>, <span style=color:#e6db74>&#34;admin&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>First the database is set up. Then a new <code>UserRepository</code> is created for the test with a reference to the connection pool of the database <code>connPool</code>. No we run the method to test <code>userRepository.FindByUsername(ctx, "admin")</code> and verify the result. But wait, where did that database container come from? Right, we&rsquo;ll set that up using <a href=https://golang.testcontainers.org/>Testcontainers</a> and <a href=https://www.docker.com/>Docker</a>.</p><h2 id=database-setup-using-testcontainers>Database Setup using Testcontainers</h2><p>We set up the <a href=https://www.postgresql.org/>PostgreSQL</a> database in a <a href=https://www.docker.com/>Docker</a> container using the <a href=https://golang.testcontainers.org/>Testcontainers</a> lib.</p><p>As a first step we create a <code>testcontainers.ContainerRequest</code> where we set the Docker image to <code>postgres:14</code> with exposed port <code>5432/tcp</code>. Additionaly the database name as well as username and password are set using environment variables. And to make sure the tests only starts when the database container is up and running we wait for it using the <code>WaitingFor</code> option with <code>wait.ForListeningPort("5432/tcp")</code>.</p><p>Now as second step we start the requested container.</p><p>Finally in step 3 we use host and port of the running database container to create the connection string for the database with <code>fmt.Sprintf("postgres://postgres:postgres@%v:%v/testdb", host, port.Port())</code>. Now we connect with <code>pgxpool.Connect(context.Background(), dbURI)</code>.</p><p>The whole method <code>SetupTestDatabase</code> to set up the PostgreSQL container is (errors omitted):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SetupTestDatabase</span>() (<span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>pgxpool</span>.<span style=color:#a6e22e>Pool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 1. Create PostgreSQL container request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>containerReq</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>ContainerRequest</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Image</span>:        <span style=color:#e6db74>&#34;postgres:latest&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ExposedPorts</span>: []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;5432/tcp&#34;</span>},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WaitingFor</span>:   <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>ForListeningPort</span>(<span style=color:#e6db74>&#34;5432/tcp&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Env</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;POSTGRES_DB&#34;</span>:       <span style=color:#e6db74>&#34;testdb&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;POSTGRES_PASSWORD&#34;</span>: <span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;POSTGRES_USER&#34;</span>:     <span style=color:#e6db74>&#34;postgres&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 2. Start PostgreSQL container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dbContainer</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>GenericContainer</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>GenericContainerRequest</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContainerRequest</span>: <span style=color:#a6e22e>containerReq</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Started</span>:          <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 3.1 Get host and port of PostgreSQL container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dbContainer</span>.<span style=color:#a6e22e>Host</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dbContainer</span>.<span style=color:#a6e22e>MappedPort</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;5432&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 3.2 Create db connection string and connect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dbURI</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;postgres://postgres:postgres@%v:%v/testdb&#34;</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>.<span style=color:#a6e22e>Port</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>connPool</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pgxpool</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>dbURI</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dbContainer</span>, <span style=color:#a6e22e>connPool</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Notice that we make sure the PostgreSQL container is terminated after our integration tests with <code>defer dbContainer.Terminate(context.Background())</code>.</p><h2 id=adding-database-migrations>Adding Database Migrations</h2><p>So far our test starts out with an empty database. That&rsquo;s not very useful since we need the database tables of our application. In our simple example we need the table <code>users</code>. We will now set up our database using <a href=https://github.com/golang-migrate/migrate>golang-migrate</a>.</p><p>We add the database migrations to the <code>SetupTestDatabase()</code> method by adding the call <code>MigrateDb(dbURI)</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SetupTestDatabase</span>() (<span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>pgxpool</span>.<span style=color:#a6e22e>Pool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ... (see before)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 3.2 Create db connection string and connect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dbURI</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;postgres://postgres:postgres@%v:%v/testdb&#34;</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>.<span style=color:#a6e22e>Port</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MigrateDb</span>(<span style=color:#a6e22e>dbURI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>connPool</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pgxpool</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>dbURI</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dbContainer</span>, <span style=color:#a6e22e>connPool</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The method <code>MigrateDb(dbURI)</code> applies the database migration scripts to the database using <a href=https://github.com/golang-migrate/migrate>golang-migrate</a>. The migration scripts are read from the directory <code>migrations</code> which is embedded into the binary of our application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//go:embed migrations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>migrations</span> <span style=color:#a6e22e>embed</span>.<span style=color:#a6e22e>FS</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MigrateDb</span>(<span style=color:#a6e22e>dbURI</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>source</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>iofs</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>migrations</span>, <span style=color:#e6db74>&#34;migrations&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>migrate</span>.<span style=color:#a6e22e>NewWithSourceInstance</span>(<span style=color:#e6db74>&#34;iofs&#34;</span>, <span style=color:#a6e22e>source</span>, <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>dbURI</span>, <span style=color:#e6db74>&#34;postgres://&#34;</span>, <span style=color:#e6db74>&#34;pgx://&#34;</span>, <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Up</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>migrate</span>.<span style=color:#a6e22e>ErrNoChange</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=wrap-up>Wrap Up</h2><p>We have a working setup for integration tests against a real <a href=https://www.postgresql.org/>PostgreSQL</a> database running in <a href=https://www.docker.com/>Docker</a> using <a href=https://golang.testcontainers.org/>Testcontainers</a>. We can use this setup for integration tests of our persistence layer. But that&rsquo;s not all it&rsquo;s good for.</p><p>This setup is a great way for all kinds of integration tests that need infrastructure. E.g. a test that send emails to an mail server running in docker, as in <a href=https://github.com/Baralga/baralga-app/blob/main/shared/mail_resource_smtp_test.go>mail_resource_smtp_test.go</a>.</p><p>Code see <a href=https://github.com/remast/go-for-testcontainers>github.com/remast/go-for-testcontainers</a></p></article></div></body></html>